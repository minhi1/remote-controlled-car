<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Remote Control Car</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">
</head>
<body>

<header>
  <h2>Remote Control Car</h2>
  <div class="status-bar">
    <span><span class="status-dot"></span>Car</span>
    <span id="camStatus"><span class="status-dot"></span>Cam</span>
  </div>
</header>

<main>
  <div class="main-container">
    <div class="center-column">
      <div class="controls-wrapper">
        <div class="controls">
          <button data-cmd="4">‚Üñ</button>
          <button data-cmd="2">‚Üë</button>
          <button data-cmd="5">‚Üó</button>
          <div></div>
          <button class="stop" data-cmd="1">STOP</button>
          <div></div>
          <button data-cmd="6">‚Üô</button>
          <button data-cmd="3">‚Üì</button>
          <button data-cmd="7">‚Üò</button>
        </div>
        <button class="capture-btn" onclick="captureFrame()">Capture (C)</button>
      </div>

      <div class="camera-wrapper">
        <img id="video">
        <div class="dashboard">
          <div class="mic-control" id="mic">
            <span id="micIcon">üé§</span>
            <div class="volume-bar" id="volBar">
              <div class="volume-fill" id="volFill"></div>
              <div class="volume-knob" id="volKnob"></div>
            </div>
          </div>
          <button class="gallery-btn" onclick="toggleGallery()">üìÅ Gallery</button>
        </div>
      </div>
    </div>

    <div class="activity-log">
      <h3>Activity Log</h3>
      <div id="logContainer"></div>
    </div>
  </div>
</main>

<div class="gallery" id="gallery">
  <button class="close-gallery" onclick="toggleGallery()">Close</button>
  <div class="gallery-grid" id="galleryGrid"></div>
</div>

<style>
/* Desktop Layout: 3 columns - controls, camera, log */
.main-container {
  display: grid;
  grid-template-columns: auto 1fr auto;
  grid-template-rows: 1fr;
  gap: 20px;
  padding: 15px;
  height: calc(100vh - 80px);
  max-width: 100%;
  margin: 0;
  align-items: stretch;
}

/* Use display: contents to make children direct grid items */
.center-column {
  display: contents;
}

/* Controls wrapper as first column */
.controls-wrapper {
  grid-column: 1;
  grid-row: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

.camera-wrapper {
  grid-column: 2;
  grid-row: 1;
  width: 100%;
  height: 100%;
  min-height: 0;
  position: relative;
}

.controls {
  display: grid;
  grid-template-columns: repeat(3, 64px);
  grid-template-rows: repeat(3, 48px);
  gap: 6px;
}

.capture-btn {
  width: 100%;
  max-width: 200px;
  padding: 8px 0;
  font-size: 12px;
}

.activity-log {
  grid-column: 3;
  grid-row: 1;
  position: static;
  width: 300px;
  background: rgba(0, 0, 0, 0.85);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  height: 100%;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.activity-log h3 {
  margin: 0 0 10px 0;
  color: #4CAF50;
  font-size: 18px;
  flex-shrink: 0;
}

#logContainer {
  flex: 1;
  overflow-y: auto;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  line-height: 1.5;
  min-height: 0;
}

.log-entry {
  padding: 5px 8px;
  margin-bottom: 5px;
  border-radius: 4px;
  background: rgba(255, 255, 255, 0.05);
}

.log-entry .time {
  color: #888;
  font-size: 11px;
}

.log-entry .message {
  color: #fff;
}

.log-entry.info { border-left: 3px solid #2196F3; }
.log-entry.success { border-left: 3px solid #4CAF50; }
.log-entry.warning { border-left: 3px solid #FF9800; }
.log-entry.error { border-left: 3px solid #f44336; }

#logContainer::-webkit-scrollbar {
  width: 8px;
}

#logContainer::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
}

#logContainer::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 4px;
}

#logContainer::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.5);
}

/* Mobile Layout: camera on top, controls and log on bottom */
@media (max-width: 768px) {
  .main-container {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr auto;
    height: calc(100vh - 70px);
    padding: 10px;
    gap: 10px;
  }

  .center-column {
    display: contents;
  }

  .camera-wrapper {
    grid-column: 1 / -1;
    grid-row: 1;
    width: 100%;
    height: 100%;
  }

  .controls-wrapper {
    grid-column: 1;
    grid-row: 2;
    display: flex;
    flex-direction: column;
    gap: 8px;
    justify-content: flex-start;
    align-items: flex-start;
  }

  .controls {
    grid-template-columns: repeat(3, minmax(50px, 64px));
    grid-template-rows: repeat(3, 40px);
    gap: 4px;
  }

  .capture-btn {
    width: 100%;
    max-width: none;
    padding: 8px 0;
  }

  .activity-log {
    grid-column: 2;
    grid-row: 2;
    width: 100%;
    height: auto;
    max-height: 250px;
  }
  
  #logContainer {
    max-height: 200px;
  }
}

@media (max-width: 480px) {
  .controls {
    grid-template-columns: repeat(3, minmax(45px, 1fr));
    grid-template-rows: repeat(3, 36px);
    gap: 3px;
  }
  
  button {
    font-size: 14px;
  }
  
  .activity-log h3 {
    font-size: 14px;
  }
  
  #logContainer {
    font-size: 10px;
    max-height: 150px;
  }
}
</style>

<script>


const videoEl = document.getElementById('video');
const camStatusEl = document.getElementById('camStatus');
const buttons = document.querySelectorAll('[data-cmd]');
const STOP_CMD = '1';

let wsCar, wsCam;
let pingStart = 0;
let lastPing = 0;

// Activity logging
const logContainer = document.getElementById('logContainer');

function addLog(message, type = 'info') {
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  const time = new Date().toLocaleTimeString();
  entry.innerHTML = `<div class="time">${time}</div><div class="message">${message}</div>`;
  logContainer.insertBefore(entry, logContainer.firstChild);
  
  // Keep only last 50 entries
  while (logContainer.children.length > 50) {
    logContainer.removeChild(logContainer.lastChild);
  }
}

let micMuted = false;
let micVolume = 70;

const mic = document.getElementById('mic');
const micIcon = document.getElementById('micIcon');
const volBar = document.getElementById('volBar');
const volFill = document.getElementById('volFill');
const volKnob = document.getElementById('volKnob');

function setVolume(v) {
  micVolume = Math.max(0, Math.min(100, v));
  volFill.style.width = micVolume + '%';
  volKnob.style.left = micVolume + '%';
}

micIcon.onclick = e => {
  e.stopPropagation();
  micMuted = !micMuted;
  mic.classList.toggle('muted', micMuted);
  micIcon.textContent = micMuted ? 'üîá' : 'üé§';
};

let dragging = false;

function updateFromX(x) {
  const r = volBar.getBoundingClientRect();
  setVolume(((x - r.left) / r.width) * 100);
}

volKnob.addEventListener('mousedown', e => { dragging = true; e.preventDefault(); });
document.addEventListener('mousemove', e => dragging && updateFromX(e.clientX));
document.addEventListener('mouseup', () => dragging = false);

volKnob.addEventListener('touchstart', e => {
  dragging = true;
  updateFromX(e.touches[0].clientX);
}, { passive: false });

document.addEventListener('touchmove', e => {
  if (!dragging) return;
  updateFromX(e.touches[0].clientX);
  e.preventDefault();
}, { passive: false });

document.addEventListener('touchend', () => dragging = false);

setVolume(micVolume);

function getWsUrl(path) {
  return (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + path;
}

function setActive(cmd) {
  buttons.forEach(b => b.classList.toggle('active', b.dataset.cmd === cmd));
}

function sendCmd(cmd) {
  setActive(cmd);
  if (wsCar?.readyState === 1) {
    wsCar.send(cmd);
    const cmdNames = { '1': 'STOP', '2': 'Forward', '3': 'Backward', 
                       '4': 'Forward-Left', '5': 'Forward-Right', '6': 'Backward-Left', 
                       '7': 'Backward-Right' };
    addLog(`Command sent: ${cmdNames[cmd] || cmd}`, 'info');
  }
}

setActive(STOP_CMD);

buttons.forEach(btn => {
  btn.addEventListener('mousedown', () => sendCmd(btn.dataset.cmd));
  btn.addEventListener('mouseup', () => sendCmd(STOP_CMD));
  btn.addEventListener('mouseleave', () => sendCmd(STOP_CMD));
});

const keys = new Set();

document.addEventListener('keydown', e => {
  if (e.repeat) return;
  if (e.key.toLowerCase() === 'c') return captureFrame();
  keys.add(e.key.toLowerCase());
  handleKeys();
});

document.addEventListener('keyup', e => {
  keys.delete(e.key.toLowerCase());
  handleKeys();
});

function handleKeys() {
  const w = keys.has('w') || keys.has('arrowup');
  const s = keys.has('s') || keys.has('arrowdown');
  const a = keys.has('a') || keys.has('arrowleft');
  const d = keys.has('d') || keys.has('arrowright');

  if (w && a) sendCmd('4');
  else if (w && d) sendCmd('5');
  else if (s && a) sendCmd('6');
  else if (s && d) sendCmd('7');
  else if (w) sendCmd('2');
  else if (s) sendCmd('3');
  else sendCmd(STOP_CMD);
}

function captureFrame() {
  if (!videoEl.src) return;
  const img = new Image();
  img.src = videoEl.src;

  // console.log("=== Capture Frame ===");
  // console.log(img.src);

  const item = document.createElement('div');
  addLog('Frame captured successfully', 'success');
  item.className = 'gallery-item';
  item.appendChild(img);
  item.innerHTML += `<div class="tags">AI: road, obstacle, daylight</div>`;
  document.getElementById('galleryGrid').prepend(item);
}

function updateCamStatus() {
  camStatusEl.innerHTML =
    `<span class="status-dot"></span>
     ${new Date().toLocaleTimeString()} | ${lastPing}ms`;
  requestAnimationFrame(updateCamStatus);
}
updateCamStatus();

// INIT WEBSOCKET
wsCar = new WebSocket(getWsUrl('/car'));
wsCar.onopen = () => {
  addLog('Car WebSocket connected', 'success');
};

wsCar.onerror = () => {
  addLog('Car WebSocket connection error', 'error');
};

wsCar.onclose = () => {
  addLog('Car WebSocket disconnected', 'warning');
};

wsCam = new WebSocket(getWsUrl('/cam'));
wsCam.binaryType = 'arraybuffer';

// Open connection on websocket wsCam
wsCam.onopen = () => {
  addLog('Camera WebSocket connected', 'success');
  setInterval(() => {
    pingStart = performance.now();
    wsCam.send('ping');
  }, 2000);
};

wsCam.onerror = () => {
  addLog('Camera WebSocket connection error', 'error');
};

wsCam.onclose = () => {
  addLog('Camera WebSocket disconnected', 'warning');
};

// WebSocket wsCam receives a message e
wsCam.onmessage = e => { 
  if (e.data instanceof ArrayBuffer) { 
    // e is JPEG binary frame
    const url = URL.createObjectURL(new Blob([e.data], { type: 'image/jpeg' }));
    videoEl.src = url;
    videoEl.onload = () => URL.revokeObjectURL(url);
  } else if (e.data === 'ping') {
    lastPing = Math.round(performance.now() - pingStart);
  }
};

// GALLERY
function toggleGallery() {
  document.getElementById('gallery').classList.toggle('open');
  const isOpen = document.getElementById('gallery').classList.contains('open');
  addLog(isOpen ? 'Gallery opened' : 'Gallery closed', 'info');
}

// Initial log
addLog('Remote Control Car initialized', 'success');
</script>

</body>
</html>
